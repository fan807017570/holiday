<!DOCTYPE html>
<html class="no-js">
<head>
<title>假期管理</title>
<!-- Bootstrap -->
<meta http-equiv="content-type" content="text/html; charset=utf-8" />
<link href="../bootstrap/css/bootstrap.min.css" rel="stylesheet"
	media="screen" />
<link href="../bootstrap/css/bootstrap-datetimepicker.css"
	type="text/css" />
<link href="../bootstrap/css/bootstrap-responsive.min.css"
	rel="stylesheet" media="screen" />
<link href="../bootstrap/css/jquery.easy-pie-chart.css" rel="stylesheet"
	media="screen" />
<link href="../bootstrap/css/styles.css" rel="stylesheet" media="screen" />
<link href="../css/leave.css" rel="stylesheet" media="screen" />
<script src="../scripts/jquery.min.js"></script>

<script src="../bootstrap/js/bootstrap.min.js" type="text/javascript"></script>
<script src="../scripts/bootstrap.min.js"></script>
<script src="../scripts/forleave.js"></script>
<script src="../bootstrap/js/modernizr-2.6.2-respond-1.1.0.min.js"></script>
</head>
<body>
	<div class="navbar navbar-fixed-top">
		<input type="hidden" th:value="${userId}" id="_userId" />
		<div class="navbar-inner">
			<div class="container-fluid">
				<a class="btn btn-navbar" data-toggle="collapse"
					data-target=".nav-collapse"> <span class="icon-bar"></span> <span
					class="icon-bar"></span> <span class="icon-bar"></span>
				</a> <a class="brand" href="#">假期管理</a>
				<div class="nav-collapse collapse">
					<ul class="nav pull-right">
						<li class="dropdown"><a href="#" role="button"
							class="dropdown-toggle" data-toggle="dropdown"> <i
								class="icon-user"></i>用户名 <i class="caret"></i>

						</a>
							<ul class="dropdown-menu">
								<li><a tabindex="-1" href="#">用户名</a></li>
								<li class="divider"></li>
								<li><a tabindex="-1" href="login.html">退出</a></li>
							</ul></li>
					</ul>
					<ul class="nav">
						<li class="dropdown"><a href="#" role="button"
							class="dropdown-toggle" data-toggle="dropdown">用户假期 <i
								class="caret"></i>

						</a>
							<ul class="dropdown-menu">
								<li><a tabindex="-1" href="#">用户信息</a></li>
								<li><a tabindex="-1" href="#">用户拥有的假期</a></li>
								<li><a tabindex="-1" href="#">我的假单</a></li>
							</ul></li>
					</ul>
				</div>
				<!--/.nav-collapse -->
			</div>
		</div>
	</div>
	<div class="container-fluid">
		<div class="row-fluid">
			<div class="span3" id="sidebar">
				<ul class="nav nav-list bs-docs-sidenav nav-collapse collapse">
					<li><a href="../index/index"><i class="icon-chevron-right"></i>
							用户享有假期</a></li>
					<li class="active"><a href="../index/toLeave.html"><i
							class="icon-chevron-right"></i> 请假申请</a></li>
					<li><a href="../index/myLeaveList"><i
							class="icon-chevron-right"></i> 我的假单</a></li>
				</ul>
			</div>

			<!--/span-->
			<br></br>

			<div class="span9" id="content">
				<div class="row-fluid">
					<!-- block -->
					<div class="block">
						<div class="navbar navbar-inner block-header">
							<div class="muted pull-left">假单信息</div>
							<!-- <div class="pull-right">
								<span class="badge badge-warning">View More</span>

							</div> -->
						</div>
						<div class="block-content collapse in">
							<form class="form-horizontal">
								<fieldset>
									<div class="span6">
										<div class="control-group">
											<label class="control-label" for="dtp_input2">开始时间:</label>
											<div class="controls">
												<div class="input-group date form_date " data-date=""
													data-date-format="dd MM yyyy" data-link-field="dtp_input2"
													data-link-format="yyyy-mm-dd" id="_startTime">
													<input class="form-control form-group input-large"
														size="15" type="text" value="" readonly="true" /> <span
														class="input-group-addon"><span
														class="glyphicon glyphicon-remove"></span></span> <span
														class="input-group-addon"><span
														class="glyphicon glyphicon-calendar"></span></span>
												</div>
											</div>
										</div>
										<div class="control-group">
											<label class="control-label" for="_vocationType">选择假期类型:</label>
											<div class="controls">
												<select id="_vocationType">
													<option>请选择</option>
													<!-- <option>年假</option>
                                              <option>婚假</option>
                                              <option>事假</option>
                                              <option>探亲假</option> -->
												</select>
											</div>
										</div>

										<div class="control-group">
											<label class="control-label" for="disabledInput">享有时长:</label>
											<div class="controls">
												<input class="input-large disabled" id="_termTime"
													type="text" size="15" placeholder="享有时长" disabled=""></input><span
													class="help-inline">天</span>
											</div>
										</div>
									</div>
									<div class="span6">
										<div class="control-group">
											<label class="control-label" for="dtp_input2">结束时间:</label>
											<div class="controls">
												<div class="input-group date form_date " data-date=""
													data-date-format="dd MM yyyy" data-link-field="dtp_input2"
													data-link-format="yyyy-mm-dd" id="_endTime">
													<input class="form-control form-group input-large"
														size="15" type="text" value="" readonly="true" /> <span
														class="input-group-addon"><span
														class="glyphicon glyphicon-remove"></span></span> <span
														class="input-group-addon"><span
														class="glyphicon glyphicon-calendar"></span></span>
												</div>
											</div>
										</div>
										<div class="control-group">
											<label class="control-label" for="selectError">选择审批人:</label>
											<div class="controls">
												<select id="_admins">
													<option>审批人</option>
												</select>
											</div>
										</div>

										<div class="control-group">
											<label class="control-label" for="disabledInput">结余时长:</label>
											<div class="controls">
												<input class="input-large disabled" id="_balanceTime"
													type="text" size="15" placeholder="结余时长" disabled=""></input><span
													class="help-inline">天</span>
											</div>
										</div>
									</div>
									<div class="control-group">
										<label class="control-label" for="inputError">请假理由:</label>
										<div class="controls">
											<textarea class="input-large" rows="3" style="width: 91%"
												id="_comment"></textarea>
										</div>
									</div>
									<div class="form-actions">
										<button type="button" class="btn btn-primary" id="_tosubmit">暂存</button>
										<button type="button" class="btn" id="_submit" disabled="true">保存</button>
									</div>
								</fieldset>
							</form>
						</div>
					</div>
					<!-- /block -->
				</div>
				<!-- <div class="col-xs-3  col-xs-offset-4 form-group">
					<button type="button" class="btn btn-default" id="_tosubmit">暂存</button>
				</div>
				<div class="col-xs-3 form-group">
					<button type="button" class="btn btn-default" id="_submit">提交</button>
				</div> -->
			</div>
		</div>
		<hr></hr>
		<!-- <footer>
			<p>Vincent Gabriel 2013</p>
		</footer> -->
	</div>
	<!--/.fluid-container-->
	<script src="../bootstrap/js/jquery.min.js" type="text/javascript"></script>
	<script src="../bootstrap/js/bootstrap.min.js" type="text/javascript"></script>
	<script src="../bootstrap/js/jquery.easy-pie-chart.js"></script>
	<script src="../bootstrap/js/scripts.js"></script>
	<script type="text/javascript"
		src="../bootstrap/js/bootstrap-datetimepicker.min.js" charset="UTF-8"></script>
	<script type="text/javascript"
		src="../bootstrap/js/bootstrap-datetimepicker.zh-CN.js"
		charset="UTF-8"></script>
	<script type="text/javascript">
		var vocationMap = new Object();
		var adminMap = new Object();
		var record = new Object();
		//通过选择的假期类型获取假期id
		function findVocationId(vname) {
			var vocation = JSON.parse(vocationMap);
			for ( var key in vocation) {
				if (vname == vocation[key].vname) {
					return vocation[key].vId;
				}
			}
		};
		function findAdminId(name) {
			var admin = JSON.parse(adminMap);
			for ( var key in admin) {
				if (name == admin[key].realName) {
					return admin[key].userId;
				}
			}
		};
		$("#_vocationType").change(function() {
			var vid = findVocationId($("#_vocationType").val());
			var uid = $("#_userId").val();
			$.get("../user/getEnvotionInfo", {
				vId : vid,
				uId : uid
			}, function(data) {
				var ret = $.parseJSON(data);
				if (ret.length == 0) {
					alert("该假期！");
				} else {
					$("#_balanceTime").val(ret.balanceTime);
					$("#_termTime").val(ret.term);
				}

			});

		});
		//提交假期
		$('#_tosubmit').click(
				function() {
					var userId = $("#_userId").val();
					var vid = findVocationId($("#_vocationType").val());
					var s = $("#_startTime").datetimepicker('getDate')
							.toLocaleString();
					var e = $("#_endTime").datetimepicker('getDate')
							.toLocaleString();
					var start = new Date(s);
					var end = new Date(e); 
					var duration = Math.abs(end - start) / 86400000;
					var commitTime = null;
					var orderTime = null;
					var status = 1;
					var createTime = new Date();
					var approverId = findAdminId($("#_admins").val());
					record.userId = userId;
					record.vid = vid;
					record.start = start;
					record.end = end;
					record.duration = duration;
					record.commitTime = commitTime;
					record.orderTime = orderTime;
					record.status = 1;
					record.createTime = createTime;
					record.approverId = approverId;
					record.comment = $("#_comment").val();
					$.ajax({
						type : 'POST',
						contentType : "application/json",
						url : "../user/postRecord",
						data : JSON.stringify(record),
						success : function(data) {
							if (data == 1) {
								alert("保存成功！");
							} else if (data == -1) {
								alert("您有待处理的加单！ ");
							} else {
								alert("插入数据异常！ ");
							}
						},
						dataType : "json"
					});
				});
		$("#_submit").click(function() {
			alert("ok");
			$("form:input").each(function() {

			});
		});
		$('.form_date').datetimepicker({
			language : 'zh-CN',
			weekStart : 1,
			todayBtn : 1,
			autoclose : 1,
			todayHighlight : 1,
			startView : 2,
			minView : 2,
			forceParse : 0
		});
		$(document).ready(function() {
			var uid = $("#_userId").val();
			$.get("../user/getUerVocation", {
				userId : uid
			}, function(data) {
				vocationMap = data;
				var ret = $.parseJSON(data);
				for ( var key in ret) {
					var html = '<option>' + ret[key].vname + '</option>'
					$("#_vocationType").append(html);
				}
			});

			$.get("../user/getAdmin", {
				roleId : 1
			}, function(data) {
				adminMap = data;
				var ret = $.parseJSON(data);
				for ( var key in ret) {
					var html = '<option>' + ret[key].realName + '</option>'
					$("#_admins").append(html);
				}
			});
		});
	</script>
</body>
</html>